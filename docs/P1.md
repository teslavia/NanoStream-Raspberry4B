# P1 交付清单与验收标准

本清单覆盖 P1 阶段两项任务：
1) OSD 叠加（cairooverlay）
2) WebRTC 接入（MediaMTX 旁路）

目标：在不破坏现有 RTSP 推流的前提下，提升可视化反馈与浏览器端低延迟接入能力。

---

## P1-1 OSD 叠加（cairooverlay）

### 交付物
- 视频流中实时绘制检测框与标签
- 延迟可接受且稳定，不导致推流轨卡顿

### 实施清单
1. **数据共享结构完善**
   - 共享检测结果结构包含：x,y,w,h,label,score
   - 增加 `timestamp_ms`（检测输出时间）
   - 增加 `version`（自增版本号）
2. **绘制读取策略**
   - draw 回调读取最新 version 的结果
   - 若结果超过超时阈值（例如 500ms），可选择不绘制
3. **坐标一致性**
   - 320x320 → 640x480 映射公式固定
   - 绘制前统一 clamp 到画布范围
4. **性能与稳定性**
   - 空结果不绘制标签背景
   - 可选：每 N 帧绘制一次（减轻 Cairo 压力）

### 验收标准
- 画面内至少 1 个目标出现时，OSD 绿框可见且位置稳定
- 平均推流延迟无明显上升（主观确认，或 FPS 无明显下降）
- 系统运行 10 分钟无崩溃/卡死

### 测试步骤
1. 运行 `./build/NanoStream`，使用 VLC 连接 RTSP
2. 人为移动目标，观察框是否跟随且不明显漂移
3. 连续运行 10 分钟，确认无段错误/卡顿

---

## P1-2 WebRTC 旁路接入（MediaMTX）

### 交付物
- MediaMTX 部署模板（docker-compose.yml + mediamtx.yml）
- 简明使用说明与验证步骤

### 实施清单
1. **部署模板**
   - 提供 `deploy/mediamtx/docker-compose.yml`
   - 提供 `deploy/mediamtx/mediamtx.yml`
2. **接入说明**
   - WebRTC URL 使用说明
   - RTSP 源地址配置方式
3. **验证路径**
   - 浏览器打开 WebRTC 页面
   - 观察画面延迟与稳定性

### 验收标准
- 浏览器可直接播放 WebRTC 画面
- 画面延迟明显低于 RTSP
- 10 分钟内无断流或黑屏

### 测试步骤
1. `cd deploy/mediamtx && docker compose up -d`
2. 浏览器访问 `http://<Pi_IP>:8889/` 选择 `live`
3. 同时打开 RTSP 对比延迟

### 离线本地播放页
如浏览器访问 8889 返回 404，可使用本地页面：
`deploy/mediamtx/webrtc-simple.html`

使用方法：
1. 在 Mac/PC 用浏览器打开该 HTML
2. 填入 `http://<Pi_IP>:8889/` 后点击 Start
3. Path 填 `live`（与 RTSP 路径一致）

如果 Start 仍提示 404：
- 确认 MediaMTX 正在运行且日志显示 WebRTC listener opened
- 确认 NanoStream 正在推流 `rtsp://<Pi_IP>:8554/live`
- 若仍失败，尝试更新到最新 `webrtc-simple.html`（已内置多端点自动兼容）

说明：
- MediaMTX v1.15.x 使用 WHEP/WHIP 风格端点，可能返回 SDP 纯文本
- 部分版本可能使用 `/{path}/webrtc` 格式的端点
- 本地播放页已支持 `application/sdp` 与多种端点格式自动适配
